@model RuleEngine.Mvc.ViewModels.RuleMetadataIndexViewModel
@{
    ViewData["Title"] = "Metadata Listesi";
}

<style>
    .popover {
        max-width: 100%;
    }

    pre {
        max-width: 500px !important;
        white-space: pre-wrap !important;
    }
</style>

<div class="buttons bottom-12" style="margin-top: -30px;">
    <a href="@Url.Action("Detail")" class="btn btn-success btn-sm">Yeni</a>
    <button class="btn btn-info btn-sm" id="createSampleDataBtn">Örnek Veriler Ekle</button>
</div>

<div class="card">
    <div class="card-body">
        <div class="datatable-options buttons mb-3">
            <button class="btn btn-outline-secondary btn-sm"><i class="fas fa-th"></i></button>
            <button class="btn btn-outline-secondary btn-sm"><i class="fas fa-file-pdf"></i></button>
            <button class="btn btn-outline-secondary btn-sm"><i class="fas fa-print"></i></button>
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#tableCollapse" aria-expanded="true" aria-controls="tableCollapse"><i class="fas fa-minus"></i></button>
        </div>
        
        <div id="listContainer" class="datatable-search bottom-10">
            <div class="row">
                <div class="col-sm-12">
                    <input type="text" name="Name" class="form-control d-inline-block w-auto me-2" placeholder="Adı" />
                    <input type="text" name="Title" class="form-control d-inline-block w-auto me-2" placeholder="Başlık" />
                    <input type="text" name="ExpressionString" class="form-control d-inline-block w-auto me-2" placeholder="Expression" />
                    <select name="CategoryItems" class="form-select d-inline-block w-auto me-2" multiple>
                        @foreach (var item in Model.CategoryItems)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                    <button class="btn btn-primary" id="ListButton">Ara</button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">Filtreleme</button>
                </div>
            </div>
            <div class="row">
                <div class="collapse col-sm-12" id="filterCollapse">
                    <div class="mt-2">
                        <select name="IsPredicate" class="form-select d-inline-block w-auto">
                            <option value="">Hepsi</option>
                            <option value="True">Evet</option>
                            <option value="False">Hayır</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="collapse show" id="tableCollapse">
            <div class="row bottom-10">
                <div class="col-lg-12">
                    <div id="list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            if (typeof $.fn.select2 !== 'undefined') {
                $("select[name='CategoryItems']").select2({ 
                    tags: true, 
                    placeholder: "Seçiniz",
                    width: '200px'
                });
            }
            
            $("#ListButton").click(function() {
                loadRuleList();
            });
            
            $("#createSampleDataBtn").click(function() {
                createSampleData();
            });
            
            loadRuleList();
        });
        
        function loadRuleList() {
            var request = {
                Name: $("input[name='Name']").val(),
                Title: $("input[name='Title']").val(),
                ExpressionString: $("input[name='ExpressionString']").val(),
                IsPredicate: $("select[name='IsPredicate']").val(),
                CategoryItems: $("select[name='CategoryItems']").val() || []
            };
            
            $.ajax({
                url: '@Url.Action("List")',
                type: 'POST',
                data: request,
                success: function(result) {
                    renderRuleList(result);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading rules:', error);
                }
            });
        }
        
        function renderRuleList(data) {
            var html = '<table class="table table-striped">';
            html += '<thead><tr>';
            html += '<th>ID</th><th>Adı</th><th>Başlık</th><th>Kural mı?</th><th>Kategori</th><th>Expression</th><th>Açıklama</th><th>Operasyonlar</th>';
            html += '</tr></thead><tbody>';
            
            if (data.data && data.data.length > 0) {
                data.data.forEach(function(item) {
                    html += '<tr>';
                    html += '<td>' + item.id + '</td>';
                    html += '<td>' + item.name + '</td>';
                    html += '<td>' + item.title + '</td>';
                    html += '<td>' + (item.isPredicate ? 'Evet' : 'Hayır') + '</td>';
                    html += '<td>' + (item.categories ? item.categories.join(', ') : '') + '</td>';
                    
                    var expression = item.expressionString || '';
                    var shortExpression = expression.length > 70 ? expression.substring(0, 70) + '...' : expression;
                    html += '<td>' + shortExpression + '</td>';
                    html += '<td>' + (item.description || '') + '</td>';
                    html += '<td>';
                    html += '<div class="dropdown">';
                    html += '<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">';
                    html += '<i class="fas fa-ellipsis-v"></i>';
                    html += '</button>';
                    html += '<ul class="dropdown-menu">';
                    html += '<li><a class="dropdown-item" href="@Url.Action("Detail")?id=' + item.id + '">Düzenle</a></li>';
                    html += '<li><a class="dropdown-item text-danger" href="#" onclick="removeRule(' + item.id + ', \'' + item.name + '\')">Sil</a></li>';
                    html += '</ul>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                });
            } else {
                html += '<tr><td colspan="8" class="text-center">Kayıt bulunamadı</td></tr>';
            }
            
            html += '</tbody></table>';
            $("#list").html(html);
        }
        
        function removeRule(id, name) {
            if (confirm(name + ' adındaki metadata\'yı silmek istediğinize emin misiniz?')) {
                $.ajax({
                    url: '@Url.Action("Remove")',
                    type: 'POST',
                    data: { id: id },
                    success: function(result) {
                        if (result.isSuccess) {
                            alert('Kayıt başarıyla silindi');
                            loadRuleList();
                        } else {
                            alert('Hata: ' + result.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Hata: ' + error);
                    }
                });
            }
        }
        
        function createSampleData() {
            if (confirm('Basitten karmaşığa 9 adet örnek kural eklemek istediğinize emin misiniz?')) {
                $.ajax({
                    url: '@Url.Action("CreateSampleData")',
                    type: 'POST',
                    success: function(result) {
                        if (result.isSuccess) {
                            alert(result.message);
                            loadRuleList();
                        } else {
                            alert('Hata: ' + result.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Hata: ' + error);
                    }
                });
            }
        }
    </script>
}
